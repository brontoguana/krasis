2026-02-15 14:06:44,362 krasis.server INFO Strategy: auto (expert_divisor=0 for neutral init)
2026-02-15 14:06:44,363 krasis.model INFO KrasisModel: 48 layers, PP=[48], 1 GPUs, attn=flashinfer, hybrid=12 full + 36 linear
2026-02-15 14:06:44,408 krasis.server INFO Loading model...
2026-02-15 14:06:44,408 krasis.model INFO RAM budget: experts=39.9 GB, overhead=20.0 GB, total=59.9 GB needed | system: 995.5 GB total, 946.5 GB available
2026-02-15 14:06:44,408 krasis.model INFO RAM budget OK: 59.9 GB needed, 935.6 GB headroom
2026-02-15 14:06:44,409 krasis.model INFO RAM watchdog started: will exit if < 5.0% free
2026-02-15 14:06:44,409 krasis.model INFO Phase 1: Loading GPU weights (streaming INT8)...
2026-02-15 14:06:44,444 krasis.weight_loader INFO Loading embedding: model.embed_tokens.weight
2026-02-15 14:06:44,826 krasis.weight_loader INFO Layer 0 loaded in 0.2s (GPU alloc: 631 MB, moe=True, type=linear_attention)
2026-02-15 14:06:44,991 krasis.weight_loader INFO Layer 1 loaded in 0.1s (GPU alloc: 672 MB, moe=True, type=linear_attention)
2026-02-15 14:06:45,142 krasis.weight_loader INFO Layer 2 loaded in 0.2s (GPU alloc: 714 MB, moe=True, type=linear_attention)
2026-02-15 14:06:45,264 krasis.weight_loader INFO Layer 3 loaded in 0.1s (GPU alloc: 749 MB, moe=True, type=full_attention)
2026-02-15 14:06:45,265 krasis.attention INFO Layer 3: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:45,427 krasis.weight_loader INFO Layer 4 loaded in 0.2s (GPU alloc: 926 MB, moe=True, type=linear_attention)
2026-02-15 14:06:45,582 krasis.weight_loader INFO Layer 5 loaded in 0.2s (GPU alloc: 967 MB, moe=True, type=linear_attention)
2026-02-15 14:06:45,735 krasis.weight_loader INFO Layer 6 loaded in 0.2s (GPU alloc: 1009 MB, moe=True, type=linear_attention)
2026-02-15 14:06:45,858 krasis.weight_loader INFO Layer 7 loaded in 0.1s (GPU alloc: 1044 MB, moe=True, type=full_attention)
2026-02-15 14:06:45,858 krasis.attention INFO Layer 7: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:46,021 krasis.weight_loader INFO Layer 8 loaded in 0.2s (GPU alloc: 1093 MB, moe=True, type=linear_attention)
2026-02-15 14:06:46,176 krasis.weight_loader INFO Layer 9 loaded in 0.2s (GPU alloc: 1134 MB, moe=True, type=linear_attention)
2026-02-15 14:06:46,335 krasis.weight_loader INFO Layer 10 loaded in 0.2s (GPU alloc: 1175 MB, moe=True, type=linear_attention)
2026-02-15 14:06:46,464 krasis.weight_loader INFO Layer 11 loaded in 0.1s (GPU alloc: 1210 MB, moe=True, type=full_attention)
2026-02-15 14:06:46,464 krasis.attention INFO Layer 11: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:46,631 krasis.weight_loader INFO Layer 12 loaded in 0.2s (GPU alloc: 1260 MB, moe=True, type=linear_attention)
2026-02-15 14:06:46,789 krasis.weight_loader INFO Layer 13 loaded in 0.2s (GPU alloc: 1301 MB, moe=True, type=linear_attention)
2026-02-15 14:06:46,950 krasis.weight_loader INFO Layer 14 loaded in 0.2s (GPU alloc: 1342 MB, moe=True, type=linear_attention)
2026-02-15 14:06:47,079 krasis.weight_loader INFO Layer 15 loaded in 0.1s (GPU alloc: 1377 MB, moe=True, type=full_attention)
2026-02-15 14:06:47,079 krasis.attention INFO Layer 15: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:47,250 krasis.weight_loader INFO Layer 16 loaded in 0.2s (GPU alloc: 1427 MB, moe=True, type=linear_attention)
2026-02-15 14:06:47,413 krasis.weight_loader INFO Layer 17 loaded in 0.2s (GPU alloc: 1468 MB, moe=True, type=linear_attention)
2026-02-15 14:06:47,574 krasis.weight_loader INFO Layer 18 loaded in 0.2s (GPU alloc: 1509 MB, moe=True, type=linear_attention)
2026-02-15 14:06:47,695 krasis.weight_loader INFO Layer 19 loaded in 0.1s (GPU alloc: 1544 MB, moe=True, type=full_attention)
2026-02-15 14:06:47,695 krasis.attention INFO Layer 19: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:47,857 krasis.weight_loader INFO Layer 20 loaded in 0.2s (GPU alloc: 1594 MB, moe=True, type=linear_attention)
2026-02-15 14:06:48,012 krasis.weight_loader INFO Layer 21 loaded in 0.2s (GPU alloc: 1635 MB, moe=True, type=linear_attention)
2026-02-15 14:06:48,166 krasis.weight_loader INFO Layer 22 loaded in 0.2s (GPU alloc: 1676 MB, moe=True, type=linear_attention)
2026-02-15 14:06:48,287 krasis.weight_loader INFO Layer 23 loaded in 0.1s (GPU alloc: 1711 MB, moe=True, type=full_attention)
2026-02-15 14:06:48,287 krasis.attention INFO Layer 23: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:48,447 krasis.weight_loader INFO Layer 24 loaded in 0.2s (GPU alloc: 1760 MB, moe=True, type=linear_attention)
2026-02-15 14:06:48,602 krasis.weight_loader INFO Layer 25 loaded in 0.2s (GPU alloc: 1802 MB, moe=True, type=linear_attention)
2026-02-15 14:06:48,756 krasis.weight_loader INFO Layer 26 loaded in 0.2s (GPU alloc: 1843 MB, moe=True, type=linear_attention)
2026-02-15 14:06:48,878 krasis.weight_loader INFO Layer 27 loaded in 0.1s (GPU alloc: 1878 MB, moe=True, type=full_attention)
2026-02-15 14:06:48,878 krasis.attention INFO Layer 27: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:49,040 krasis.weight_loader INFO Layer 28 loaded in 0.2s (GPU alloc: 1927 MB, moe=True, type=linear_attention)
2026-02-15 14:06:49,195 krasis.weight_loader INFO Layer 29 loaded in 0.2s (GPU alloc: 1969 MB, moe=True, type=linear_attention)
2026-02-15 14:06:49,347 krasis.weight_loader INFO Layer 30 loaded in 0.2s (GPU alloc: 2010 MB, moe=True, type=linear_attention)
2026-02-15 14:06:49,469 krasis.weight_loader INFO Layer 31 loaded in 0.1s (GPU alloc: 2045 MB, moe=True, type=full_attention)
2026-02-15 14:06:49,469 krasis.attention INFO Layer 31: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:49,634 krasis.weight_loader INFO Layer 32 loaded in 0.2s (GPU alloc: 2094 MB, moe=True, type=linear_attention)
2026-02-15 14:06:49,792 krasis.weight_loader INFO Layer 33 loaded in 0.2s (GPU alloc: 2135 MB, moe=True, type=linear_attention)
2026-02-15 14:06:49,947 krasis.weight_loader INFO Layer 34 loaded in 0.2s (GPU alloc: 2177 MB, moe=True, type=linear_attention)
2026-02-15 14:06:50,068 krasis.weight_loader INFO Layer 35 loaded in 0.1s (GPU alloc: 2212 MB, moe=True, type=full_attention)
2026-02-15 14:06:50,068 krasis.attention INFO Layer 35: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:50,231 krasis.weight_loader INFO Layer 36 loaded in 0.2s (GPU alloc: 2261 MB, moe=True, type=linear_attention)
2026-02-15 14:06:50,386 krasis.weight_loader INFO Layer 37 loaded in 0.2s (GPU alloc: 2302 MB, moe=True, type=linear_attention)
2026-02-15 14:06:50,542 krasis.weight_loader INFO Layer 38 loaded in 0.2s (GPU alloc: 2344 MB, moe=True, type=linear_attention)
2026-02-15 14:06:50,664 krasis.weight_loader INFO Layer 39 loaded in 0.1s (GPU alloc: 2379 MB, moe=True, type=full_attention)
2026-02-15 14:06:50,664 krasis.attention INFO Layer 39: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:50,827 krasis.weight_loader INFO Layer 40 loaded in 0.2s (GPU alloc: 2428 MB, moe=True, type=linear_attention)
2026-02-15 14:06:50,980 krasis.weight_loader INFO Layer 41 loaded in 0.2s (GPU alloc: 2469 MB, moe=True, type=linear_attention)
2026-02-15 14:06:51,137 krasis.weight_loader INFO Layer 42 loaded in 0.2s (GPU alloc: 2510 MB, moe=True, type=linear_attention)
2026-02-15 14:06:51,259 krasis.weight_loader INFO Layer 43 loaded in 0.1s (GPU alloc: 2545 MB, moe=True, type=full_attention)
2026-02-15 14:06:51,259 krasis.attention INFO Layer 43: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:51,424 krasis.weight_loader INFO Layer 44 loaded in 0.2s (GPU alloc: 2595 MB, moe=True, type=linear_attention)
2026-02-15 14:06:51,580 krasis.weight_loader INFO Layer 45 loaded in 0.2s (GPU alloc: 2636 MB, moe=True, type=linear_attention)
2026-02-15 14:06:51,734 krasis.weight_loader INFO Layer 46 loaded in 0.2s (GPU alloc: 2677 MB, moe=True, type=linear_attention)
2026-02-15 14:06:51,854 krasis.weight_loader INFO Layer 47 loaded in 0.1s (GPU alloc: 2712 MB, moe=True, type=full_attention)
2026-02-15 14:06:51,855 krasis.attention INFO Layer 47: gated attention detected (q_proj dim=8192, expected=4096)
2026-02-15 14:06:51,862 krasis.weight_loader INFO Loading final norm: model.norm.weight
2026-02-15 14:06:51,864 krasis.weight_loader INFO Loading LM head: lm_head.weight (precision=int8)
2026-02-15 14:06:53,396 krasis.model INFO GPU0: 3021 MB allocated
2026-02-15 14:06:53,396 krasis.model INFO GPU weights loaded in 9.0s
2026-02-15 14:06:53,396 krasis.model INFO Phase 2: Loading CPU expert weights (Krasis INT4)...
2026-02-15 14:06:53,396 krasis.model INFO shared_expert_gate detected — Rust engine will skip shared experts (handled on GPU)
2026-02-15 14:07:48,180 krasis.model INFO Krasis engine: 48 MoE layers, 512 experts, hidden=2048
2026-02-15 14:07:48,275 krasis.model INFO Routing weights sent to Rust engine (48 MoE layers)
2026-02-15 14:07:48,275 krasis.model INFO CPU experts loaded in 54.9s
2026-02-15 14:07:48,275 krasis.model WARNING RAM estimate deviation: estimated 39.9 GB, actual VmRSS 76.0 GB (90% off) — estimates may need recalibration
2026-02-15 14:07:48,275 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:07:48,276 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 5256.7 MB budget of 13403.9 MB free)
2026-02-15 14:07:48,276 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=chunked, expert_divisor=0
2026-02-15 14:07:51,535 krasis.gpu_prefill INFO GPU buffer allocated: 830.5 MB for 512 experts
2026-02-15 14:07:51,535 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:07:51,535 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:07:51,535 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:07:51,535 krasis.kv_cache INFO KV cache: auto-sized to 31986 pages (6288.7 MB, 511.8K tokens)
2026-02-15 14:07:51,536 krasis.kv_cache INFO KV cache allocated: 12 layers × 31986 pages × 16 tokens = 5997 MB (gqa, gqa-split)
2026-02-15 14:07:51,537 krasis.model INFO Hybrid model: 12 full attention layers (KV cache), 36 linear attention layers
2026-02-15 14:07:51,823 krasis.tokenizer INFO Tokenizer loaded: vocab=151643, eos=151645, bos=-1
2026-02-15 14:07:51,823 krasis.model INFO Model fully loaded in 67.4s
2026-02-15 14:07:51,868 krasis.auto_optimise INFO Model config changed — re-optimising
2026-02-15 14:07:52,834 krasis.auto_optimise INFO Heatmap already exists at models/Qwen3-Coder-Next/.krasis_cache/auto_heatmap.json — reusing
2026-02-15 14:07:53,108 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:07:53,108 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2741.0 MB budget of 7114.5 MB free)
2026-02-15 14:07:53,108 krasis.gpu_prefill WARNING Persistent mode needs 39862.7 MB but only 6590.2 MB budget — falling back to layer_grouped (divisor=2)
2026-02-15 14:07:53,108 krasis.gpu_prefill INFO Layer-grouped mode: divisor=2, 2 groups of 24 MoE layers, ~19931.3 MB per group, 48 total MoE layers
2026-02-15 14:07:53,108 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=layer_grouped, expert_divisor=2
2026-02-15 14:07:53,108 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:07:53,108 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:07:53,108 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:07:53,108 krasis.auto_optimise WARNING Strategy 1 fell back to 2 (OOM) — syncing model
======================================================================
KRASIS AUTO-OPTIMISER
======================================================================
  Model:  Qwen3-Coder-Next
  PP:     [48]
  Target prefill: ~10000 tokens
  Decode tokens:  64
  Runs per test:  3


======================================================================
PHASE 1: GPU PREFILL STRATEGY SELECTION
Testing with 10000 token prompt, 3 runs each
======================================================================

──────────────────────────────────────────────────
  Strategy: persistent (expert_divisor=1)
  All experts in VRAM (zero DMA) — fastest if they fit
──────────────────────────────────────────────────
  Switch time: 0.3s
2026-02-15 14:09:14,453 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:09:14,453 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:09:14,453 krasis.model INFO Layer-grouped prefill: rank 0, 2 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:09:14,453 krasis.gpu_prefill INFO Pre-allocating DMA buffers: 830.5 MB (w13p=536.9, w13s=16.8, w2p=268.4, w2s=8.4)
2026-02-15 14:09:14,881 krasis.gpu_prefill INFO DMA buffers pre-faulted: 830.5 MB in 0.4s (one-time cost)
2026-02-15 14:09:16,853 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:09:16,853 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2733.4 MB budget of 7095.6 MB free)
2026-02-15 14:09:16,853 krasis.gpu_prefill INFO Hot-cached-static mode: hot experts on GPU (static), cold on CPU (parallel)
2026-02-15 14:09:16,853 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=hot_cached_static, expert_divisor=-3
2026-02-15 14:09:16,853 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:09:16,853 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:09:16,853 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:09:16,866 krasis.gpu_prefill INFO Loaded heatmap from models/Qwen3-Coder-Next/.krasis_cache/auto_heatmap.json: 15923 entries
2026-02-15 14:09:16,869 krasis.gpu_prefill INFO HCS VRAM budget: 7095.6 MB free, 3758.1 MB headroom, 2057 max experts (1.6 MB/expert)
2026-02-15 14:09:20,822 krasis.gpu_prefill INFO hot_cached_static initialized on cuda:0: 2057 experts across 48 layers (3336.5 MB) in 3.95s, min/max per layer: 33/56
2026-02-15 14:09:21,962 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:09:21,962 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:09:21,962 krasis.model INFO HCS prefill: 48 MoE layers, 1-layer groups (maximize chunk size)
2026-02-15 14:09:21,962 krasis.model INFO Layer-grouped prefill: rank 0, 48 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:09:21,962 krasis.gpu_prefill INFO Pre-allocating DMA buffers: 830.5 MB (w13p=536.9, w13s=16.8, w2p=268.4, w2s=8.4)
2026-02-15 14:09:22,374 krasis.gpu_prefill INFO DMA buffers pre-faulted: 830.5 MB in 0.4s (one-time cost)
2026-02-15 14:09:22,526 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13719.8 MB)
<frozen importlib._bootstrap_external>:1297: FutureWarning: The cuda.cudart module is deprecated and will be removed in a future release, please switch to use the cuda.bindings.runtime module instead.
<frozen importlib._bootstrap_external>:1297: FutureWarning: The cuda.nvrtc module is deprecated and will be removed in a future release, please switch to use the cuda.bindings.nvrtc module instead.
2026-02-15 14:09:23,104 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13763.0 MB)
2026-02-15 14:09:23,467 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13765.1 MB)
2026-02-15 14:09:23,834 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13768.3 MB)
2026-02-15 14:09:24,156 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13768.6 MB)
2026-02-15 14:09:24,523 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13771.7 MB)
2026-02-15 14:09:24,887 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13774.9 MB)
2026-02-15 14:09:25,252 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13777.2 MB)
2026-02-15 14:09:25,571 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13778.4 MB)
2026-02-15 14:09:25,938 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13781.6 MB)
2026-02-15 14:09:26,310 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13784.9 MB)
2026-02-15 14:09:26,683 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13788.1 MB)
2026-02-15 14:09:27,009 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13790.1 MB)
2026-02-15 14:09:27,382 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13793.5 MB)
2026-02-15 14:09:27,753 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13796.8 MB)
2026-02-15 14:09:28,124 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13800.0 MB)
2026-02-15 14:09:28,451 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13800.3 MB)
2026-02-15 14:09:28,822 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13803.5 MB)
2026-02-15 14:09:29,195 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13807.7 MB)
2026-02-15 14:09:29,569 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13809.9 MB)
2026-02-15 14:09:29,895 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13811.2 MB)
2026-02-15 14:09:30,269 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13813.6 MB)
2026-02-15 14:09:30,641 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13816.8 MB)
2026-02-15 14:09:31,014 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13820.0 MB)
2026-02-15 14:09:31,345 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13821.3 MB)
2026-02-15 14:09:31,718 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13823.7 MB)
2026-02-15 14:09:32,090 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13825.9 MB)
2026-02-15 14:09:32,465 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13827.8 MB)
2026-02-15 14:09:32,792 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13830.1 MB)
2026-02-15 14:09:33,167 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13833.3 MB)
2026-02-15 14:09:33,541 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13835.5 MB)
2026-02-15 14:09:33,916 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13839.7 MB)
2026-02-15 14:09:34,245 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13840.3 MB)
2026-02-15 14:09:34,621 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13843.2 MB)
2026-02-15 14:09:34,996 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13846.7 MB)
2026-02-15 14:09:35,370 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13849.9 MB)
2026-02-15 14:09:35,703 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13851.2 MB)
2026-02-15 14:09:36,078 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13852.3 MB)
2026-02-15 14:09:36,455 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13854.8 MB)
2026-02-15 14:09:36,831 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13857.6 MB)
2026-02-15 14:09:37,160 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13857.9 MB)
2026-02-15 14:09:37,536 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13860.1 MB)
2026-02-15 14:09:37,910 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13862.3 MB)
2026-02-15 14:09:38,285 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13865.7 MB)
2026-02-15 14:09:38,617 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13867.5 MB)
2026-02-15 14:09:38,992 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13868.7 MB)
2026-02-15 14:09:39,366 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13872.0 MB)
2026-02-15 14:09:39,739 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13873.2 MB)
2026-02-15 14:09:39,912 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:09:39,912 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:09:39,912 krasis.model INFO HCS prefill: 48 MoE layers, 1-layer groups (maximize chunk size)
2026-02-15 14:09:39,912 krasis.model INFO Layer-grouped prefill: rank 0, 48 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:09:40,066 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13735.2 MB)
2026-02-15 14:09:40,438 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13779.4 MB)
2026-02-15 14:09:40,803 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13781.5 MB)
2026-02-15 14:09:41,169 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13784.7 MB)
2026-02-15 14:09:41,489 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13784.7 MB)
2026-02-15 14:09:41,852 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13786.9 MB)
2026-02-15 14:09:42,216 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13790.1 MB)
2026-02-15 14:09:42,581 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13791.2 MB)
2026-02-15 14:09:42,900 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13791.2 MB)
2026-02-15 14:09:43,269 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13794.4 MB)
2026-02-15 14:09:43,642 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13797.7 MB)
2026-02-15 14:09:44,014 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13800.9 MB)
2026-02-15 14:09:44,343 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13800.9 MB)
2026-02-15 14:09:44,715 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13805.1 MB)
2026-02-15 14:09:45,087 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13808.3 MB)
2026-02-15 14:09:45,459 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13811.5 MB)
2026-02-15 14:09:45,786 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13810.5 MB)
2026-02-15 14:09:46,157 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13814.7 MB)
2026-02-15 14:09:46,530 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13817.2 MB)
2026-02-15 14:09:46,908 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.17s (GPU total: 13819.1 MB)
2026-02-15 14:09:47,237 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13819.1 MB)
2026-02-15 14:09:47,610 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13823.3 MB)
2026-02-15 14:09:47,982 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13826.5 MB)
2026-02-15 14:09:48,355 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13829.7 MB)
2026-02-15 14:09:48,683 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13828.7 MB)
2026-02-15 14:09:49,056 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13832.9 MB)
2026-02-15 14:09:49,429 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13836.1 MB)
2026-02-15 14:09:49,803 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13837.3 MB)
2026-02-15 14:09:50,133 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13838.3 MB)
2026-02-15 14:09:50,508 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13841.6 MB)
2026-02-15 14:09:50,884 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13841.8 MB)
2026-02-15 14:09:51,260 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13846.7 MB)
2026-02-15 14:09:51,591 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13845.8 MB)
2026-02-15 14:09:51,968 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13848.0 MB)
2026-02-15 14:09:52,347 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13850.1 MB)
2026-02-15 14:09:52,722 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13854.4 MB)
2026-02-15 14:09:53,057 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13853.4 MB)
2026-02-15 14:09:53,432 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13855.7 MB)
2026-02-15 14:09:53,809 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13857.9 MB)
2026-02-15 14:09:54,186 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13861.0 MB)
2026-02-15 14:09:54,517 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13863.9 MB)
2026-02-15 14:09:54,893 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13863.3 MB)
2026-02-15 14:09:55,268 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13866.3 MB)
2026-02-15 14:09:55,645 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13867.7 MB)
2026-02-15 14:09:55,977 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13868.6 MB)
2026-02-15 14:09:56,352 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13872.8 MB)
2026-02-15 14:09:56,727 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13872.0 MB)
2026-02-15 14:09:57,101 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13875.1 MB)
2026-02-15 14:09:57,274 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:09:57,274 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:09:57,274 krasis.model INFO HCS prefill: 48 MoE layers, 1-layer groups (maximize chunk size)
2026-02-15 14:09:57,274 krasis.model INFO Layer-grouped prefill: rank 0, 48 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:09:57,427 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13735.2 MB)
2026-02-15 14:09:57,800 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13779.4 MB)
2026-02-15 14:09:58,165 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13781.5 MB)
2026-02-15 14:09:58,529 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13783.7 MB)
2026-02-15 14:09:58,850 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13784.0 MB)
2026-02-15 14:09:59,212 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13786.2 MB)
2026-02-15 14:09:59,575 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13789.1 MB)
2026-02-15 14:09:59,941 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13792.3 MB)
2026-02-15 14:10:00,260 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.15s (GPU total: 13792.3 MB)
2026-02-15 14:10:00,628 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13796.5 MB)
2026-02-15 14:10:01,001 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13798.7 MB)
2026-02-15 14:10:01,373 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13802.9 MB)
2026-02-15 14:10:01,701 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13801.9 MB)
2026-02-15 14:10:02,076 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13805.1 MB)
2026-02-15 14:10:02,449 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13809.1 MB)
2026-02-15 14:10:02,821 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13811.5 MB)
2026-02-15 14:10:03,150 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13812.5 MB)
2026-02-15 14:10:03,522 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13814.7 MB)
2026-02-15 14:10:03,896 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13816.9 MB)
2026-02-15 14:10:04,269 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13820.1 MB)
2026-02-15 14:10:04,597 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13820.1 MB)
2026-02-15 14:10:04,970 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13824.3 MB)
2026-02-15 14:10:05,342 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13827.5 MB)
2026-02-15 14:10:05,715 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13829.8 MB)
2026-02-15 14:10:06,045 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13830.8 MB)
2026-02-15 14:10:06,420 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13833.0 MB)
2026-02-15 14:10:06,795 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13836.2 MB)
2026-02-15 14:10:07,170 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13838.4 MB)
2026-02-15 14:10:07,499 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13838.4 MB)
2026-02-15 14:10:07,875 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13840.6 MB)
2026-02-15 14:10:08,249 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13843.7 MB)
2026-02-15 14:10:08,625 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13845.9 MB)
2026-02-15 14:10:08,956 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13846.9 MB)
2026-02-15 14:10:09,332 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13849.4 MB)
2026-02-15 14:10:09,709 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13850.7 MB)
2026-02-15 14:10:10,085 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13853.9 MB)
2026-02-15 14:10:10,416 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13853.9 MB)
2026-02-15 14:10:10,792 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13857.1 MB)
2026-02-15 14:10:11,166 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13858.3 MB)
2026-02-15 14:10:11,542 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13861.4 MB)
2026-02-15 14:10:11,871 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13860.4 MB)
2026-02-15 14:10:12,246 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13863.6 MB)
2026-02-15 14:10:12,621 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13867.8 MB)
2026-02-15 14:10:12,996 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13869.0 MB)
2026-02-15 14:10:13,329 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13869.0 MB)
2026-02-15 14:10:13,703 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13872.2 MB)
2026-02-15 14:10:14,078 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13874.3 MB)
2026-02-15 14:10:14,451 krasis.gpu_prefill INFO Layer group loaded: 1 MoE layers = 830.5 MB in 0.16s (GPU total: 13876.4 MB)
2026-02-15 14:10:15,034 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:10:15,035 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2425.5 MB budget of 6326.0 MB free)
2026-02-15 14:10:15,035 krasis.gpu_prefill INFO Layer-grouped mode: divisor=2, 2 groups of 24 MoE layers, ~19931.3 MB per group, 48 total MoE layers
2026-02-15 14:10:15,035 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=layer_grouped, expert_divisor=2
2026-02-15 14:10:15,035 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:10:15,035 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:10:15,035 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:10:16,034 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:10:16,034 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:10:16,034 krasis.model INFO Layer-grouped prefill: rank 0, 2 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:10:16,034 krasis.gpu_prefill INFO Pre-allocating DMA buffers: 830.5 MB (w13p=536.9, w13s=16.8, w2p=268.4, w2s=8.4)
2026-02-15 14:10:16,441 krasis.gpu_prefill INFO DMA buffers pre-faulted: 830.5 MB in 0.4s (one-time cost)
2026-02-15 14:10:18,392 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:10:18,392 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2724.2 MB budget of 7072.6 MB free)
2026-02-15 14:10:18,392 krasis.gpu_prefill INFO Layer-grouped mode: divisor=4, 4 groups of 12 MoE layers, ~9965.7 MB per group, 48 total MoE layers
2026-02-15 14:10:18,392 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=layer_grouped, expert_divisor=4
2026-02-15 14:10:18,392 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:10:18,392 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:10:18,392 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:10:19,460 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:10:19,460 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:10:19,460 krasis.model INFO Layer-grouped prefill: rank 0, 4 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:10:19,460 krasis.gpu_prefill INFO Pre-allocating DMA buffers: 830.5 MB (w13p=536.9, w13s=16.8, w2p=268.4, w2s=8.4)
2026-02-15 14:10:19,871 krasis.gpu_prefill INFO DMA buffers pre-faulted: 830.5 MB in 0.4s (one-time cost)
2026-02-15 14:10:21,810 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:10:21,810 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2724.2 MB budget of 7072.6 MB free)
2026-02-15 14:10:21,810 krasis.gpu_prefill INFO Active-only mode: load only activated experts per-layer (zero preload)
2026-02-15 14:10:21,810 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=active_only, expert_divisor=-1
2026-02-15 14:10:21,817 krasis.gpu_prefill INFO Active-only buffer allocated: 830.5 MB for 512 expert slots
2026-02-15 14:10:21,817 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:10:21,817 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:10:21,817 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:10:22,766 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:10:22,766 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:10:22,766 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 5 chunks of 2048 tokens
/home/main/Documents/Claude/krasis/python/krasis/gpu_prefill.py:1337: UserWarning: The given buffer is not writable, and PyTorch does not support non-writable tensors. This means you can write to the underlying (supposedly non-writable) buffer using the tensor. You may want to copy the buffer to protect its data or make it writable before converting it to a tensor. This type of warning will be suppressed for the rest of this program. (Triggered internally at /pytorch/torch/csrc/utils/tensor_new.cpp:1581.)
  w13_all = torch.frombuffer(w13_bytes, dtype=torch.int32
2026-02-15 14:11:49,163 krasis.model INFO Active-only rank 0: DMA=67.84s (100329.8 MB), misses=61855, hits=0, pinned=0
2026-02-15 14:11:49,167 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:11:49,167 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:11:49,167 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:13:15,678 krasis.model INFO Active-only rank 0: DMA=67.96s (100560.1 MB), misses=61997, hits=0, pinned=0
2026-02-15 14:13:15,682 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:13:15,682 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:13:15,682 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:14:41,939 krasis.model INFO Active-only rank 0: DMA=67.81s (100313.6 MB), misses=61845, hits=0, pinned=0
2026-02-15 14:14:42,258 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:14:42,258 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2481.7 MB budget of 6466.5 MB free)
2026-02-15 14:14:42,258 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=chunked, expert_divisor=0
2026-02-15 14:14:42,262 krasis.gpu_prefill INFO GPU buffer allocated: 830.5 MB for 512 experts
2026-02-15 14:14:42,262 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:14:42,262 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:14:42,262 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:17:59,805 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:17:59,806 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 2381.9 MB budget of 6216.9 MB free)
2026-02-15 14:17:59,806 krasis.gpu_prefill INFO Hot-cached-static mode: hot experts on GPU (static), cold on CPU (parallel)
2026-02-15 14:17:59,806 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=hot_cached_static, expert_divisor=-3
2026-02-15 14:17:59,806 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:17:59,806 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:17:59,806 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:17:59,817 krasis.gpu_prefill INFO Loaded heatmap from models/Qwen3-Coder-Next/.krasis_cache/auto_heatmap.json: 15923 entries
2026-02-15 14:17:59,821 krasis.gpu_prefill INFO HCS VRAM budget: 6216.9 MB free, 3758.1 MB headroom, 1515 max experts (1.6 MB/expert)
2026-02-15 14:18:01,870 krasis.gpu_prefill INFO hot_cached_static initialized on cuda:0: 1515 experts across 48 layers (2457.4 MB) in 2.05s, min/max per layer: 22/40
2026-02-15 14:18:25,903 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:18:25,903 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 1697.4 MB budget of 4505.7 MB free)
2026-02-15 14:18:25,903 krasis.gpu_prefill INFO Active-only mode: load only activated experts per-layer (zero preload)
2026-02-15 14:18:25,903 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=active_only, expert_divisor=-1
2026-02-15 14:18:25,904 krasis.gpu_prefill INFO Active-only buffer allocated: 830.5 MB for 512 expert slots
2026-02-15 14:18:25,904 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:18:25,904 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:18:25,904 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:18:49,499 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:18:49,500 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 1982.6 MB budget of 5218.7 MB free)
2026-02-15 14:18:49,500 krasis.gpu_prefill INFO LRU cache mode: cross-layer expert caching with LRU eviction
2026-02-15 14:18:49,500 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=lru, expert_divisor=-2
2026-02-15 14:18:49,503 krasis.gpu_prefill INFO Active-only buffer allocated: 830.5 MB for 512 expert slots
2026-02-15 14:18:49,523 krasis.gpu_prefill INFO LRU cache buffer allocated: 2264.3 MB for 1396 expert slots (1.6 MB/slot)
2026-02-15 14:18:49,523 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:18:49,523 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:18:49,523 krasis.model INFO GPU prefill: 1 managers, threshold=300 tokens
2026-02-15 14:19:36,224 krasis.auto_optimise INFO Auto-optimise results saved to models/Qwen3-Coder-Next/.krasis_cache/auto_optimise.json
2026-02-15 14:19:36,225 krasis.auto_optimise INFO Applying auto-optimise: prefill=hcs_prefill (div=-3), decode=lru (div=-2)
2026-02-15 14:19:36,494 krasis.gpu_prefill INFO GPU prefill group_size=128
2026-02-15 14:19:36,494 krasis.gpu_prefill INFO Auto chunk_size: 512 experts (1.6 MB each, 1991.0 MB budget of 5239.7 MB free)
2026-02-15 14:19:36,494 krasis.gpu_prefill INFO LRU cache mode: cross-layer expert caching with LRU eviction
2026-02-15 14:19:36,494 krasis.gpu_prefill INFO GpuPrefillManager(engine): experts=512, hidden=2048, intermediate=512, chunk_size=512, num_chunks=1, shared=1, scale=1.000, num_bits=4, prefill_mode=lru, expert_divisor=-2
2026-02-15 14:19:36,495 krasis.gpu_prefill INFO Active-only buffer allocated: 830.5 MB for 512 expert slots
2026-02-15 14:19:36,496 krasis.gpu_prefill INFO LRU cache buffer allocated: 2285.4 MB for 1409 expert slots (1.6 MB/slot)
2026-02-15 14:19:36,496 krasis.model INFO GPU prefill manager created for cuda:0
2026-02-15 14:19:36,496 krasis.gpu_prefill INFO Engine path: Marlin-native DMA copy (zero conversion, zero RAM cache)
2026-02-15 14:19:36,497 krasis.model INFO GPU prefill: 1 managers, threshold=1 tokens
2026-02-15 14:19:36,497 krasis.auto_optimise INFO Strategy: lru, threshold=1
2026-02-15 14:19:37,387 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:19:37,388 krasis.model INFO Prefill chunking: M=16, chunk_size=2048 (1 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:19:37,388 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 1 chunks of 2048 tokens
2026-02-15 14:19:38,308 krasis.model INFO Active-only rank 0: DMA=0.00s (0.0 MB), misses=0, hits=0, pinned=0
2026-02-15 14:19:39,280 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:19:39,280 krasis.model INFO Prefill chunking: M=16, chunk_size=2048 (1 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:19:39,281 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 1 chunks of 2048 tokens
2026-02-15 14:19:40,208 krasis.model INFO Active-only rank 0: DMA=0.00s (0.0 MB), misses=0, hits=0, pinned=0
2026-02-15 14:19:41,181 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:19:41,181 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:19:41,181 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:22:41,685 krasis.model INFO Active-only rank 0: DMA=152.73s (99854.5 MB), misses=61562, hits=0, pinned=0
2026-02-15 14:22:41,689 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:22:41,689 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:22:41,689 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:25:43,183 krasis.model INFO Active-only rank 0: DMA=153.65s (100172.5 MB), misses=61758, hits=0, pinned=0
2026-02-15 14:25:43,188 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:25:43,188 krasis.model INFO Prefill chunking: M=10000, chunk_size=2048 (5 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:25:43,188 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 5 chunks of 2048 tokens
2026-02-15 14:28:44,722 krasis.model INFO Active-only rank 0: DMA=153.63s (100182.2 MB), misses=61764, hits=0, pinned=0
2026-02-15 14:28:44,725 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:28:44,725 krasis.model INFO Prefill chunking: M=16, chunk_size=2048 (1 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:28:44,725 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 1 chunks of 2048 tokens
2026-02-15 14:28:45,846 krasis.model INFO Active-only rank 0: DMA=0.00s (0.0 MB), misses=0, hits=0, pinned=0
2026-02-15 14:28:52,233 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:28:52,233 krasis.model INFO Prefill chunking: M=16, chunk_size=2048 (1 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:28:52,233 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 1 chunks of 2048 tokens
2026-02-15 14:28:53,387 krasis.model INFO Active-only rank 0: DMA=0.00s (0.0 MB), misses=0, hits=0, pinned=0
2026-02-15 14:28:59,872 krasis.model WARNING Chunk calc exception: 'ModelConfig' object has no attribute 'num_local_experts', defaulting to 2048
2026-02-15 14:28:59,873 krasis.model INFO Prefill chunking: M=16, chunk_size=2048 (1 chunks), intermediate=50 KB/tok, 105 MB peak per chunk
2026-02-15 14:28:59,873 krasis.model INFO Layer-grouped prefill: rank 0, 1 groups, 48 layers, 1 chunks of 2048 tokens
2026-02-15 14:29:01,015 krasis.model INFO Active-only rank 0: DMA=0.00s (0.0 MB), misses=0, hits=0, pinned=0
  SKIPPED: CUDA OOM

──────────────────────────────────────────────────
  Strategy: hcs_prefill (expert_divisor=-3)
  1-layer groups, hot experts skip DMA
──────────────────────────────────────────────────
  Switch time: 4.4s
  Avg: 569.9 tok/s, TTFT: 17.55s
    Run 1: 557.1 tok/s, TTFT: 17.95s
    Run 2: 576.0 tok/s, TTFT: 17.36s
    Run 3: 576.5 tok/s, TTFT: 17.35s
  VRAM: GPU0=12963MB

──────────────────────────────────────────────────
  Strategy: layer_grouped_2 (expert_divisor=2)
  2-layer groups, amortised DMA
──────────────────────────────────────────────────
  Switch time: 0.4s
  SKIPPED: CUDA OOM

──────────────────────────────────────────────────
  Strategy: layer_grouped_4 (expert_divisor=4)
  4-layer groups, fewer DMA rounds
──────────────────────────────────────────────────
  Switch time: 0.4s
  SKIPPED: CUDA OOM

──────────────────────────────────────────────────
  Strategy: active_only (expert_divisor=-1)
  DMA only activated experts per layer
──────────────────────────────────────────────────
  Switch time: 0.4s
  Avg: 115.7 tok/s, TTFT: 86.39s
    Run 1: 115.7 tok/s, TTFT: 86.40s
    Run 2: 115.6 tok/s, TTFT: 86.52s
    Run 3: 115.9 tok/s, TTFT: 86.26s
  VRAM: GPU0=10396MB

──────────────────────────────────────────────────
  Strategy: chunked (expert_divisor=0)
  Legacy per-layer full DMA
──────────────────────────────────────────────────
  Switch time: 0.3s
  Avg: 153.0 tok/s, TTFT: 65.36s
    Run 1: 153.1 tok/s, TTFT: 65.33s
    Run 2: 152.8 tok/s, TTFT: 65.44s
    Run 3: 153.1 tok/s, TTFT: 65.32s
  VRAM: GPU0=10390MB

>>> BEST PREFILL: hcs_prefill (569.9 tok/s, TTFT: 17.55s)

======================================================================
PHASE 2: DECODE STRATEGY SELECTION
Testing with 16 token prompt, 64 decode tokens, 3 runs each
======================================================================

──────────────────────────────────────────────────
  Strategy: hcs_hybrid (expert_divisor=-3)
  Hot experts GPU + cold experts CPU in parallel
──────────────────────────────────────────────────
  Switch time: 2.4s
  Avg: 10.14 tok/s
    Run 1: 9.96 tok/s (64 tok in 6.4s, TTFT=0.93s)
    Run 2: 10.13 tok/s (64 tok in 6.3s, TTFT=0.93s)
    Run 3: 10.33 tok/s (64 tok in 6.2s, TTFT=0.93s)
  VRAM: GPU0=12328MB

──────────────────────────────────────────────────
  Strategy: compact (expert_divisor=-1)
  Cross-token LRU caching in per-layer VRAM slots
──────────────────────────────────────────────────
  Switch time: 0.3s
  Avg: 10.19 tok/s
    Run 1: 10.09 tok/s (64 tok in 6.3s, TTFT=1.05s)
    Run 2: 10.27 tok/s (64 tok in 6.2s, TTFT=0.93s)
    Run 3: 10.21 tok/s (64 tok in 6.3s, TTFT=0.91s)
  VRAM: GPU0=10663MB

──────────────────────────────────────────────────
  Strategy: lru (expert_divisor=-2)
  Cross-layer LRU expert caching
──────────────────────────────────────────────────
  Switch time: 0.3s
  Avg: 10.26 tok/s
    Run 1: 10.21 tok/s (64 tok in 6.3s, TTFT=0.90s)
    Run 2: 10.28 tok/s (64 tok in 6.2s, TTFT=0.88s)
    Run 3: 10.28 tok/s (64 tok in 6.2s, TTFT=1.01s)
  VRAM: GPU0=12928MB

──────────────────────────────────────────────────
  Strategy: pure_cpu (expert_divisor=None)
  CPU-only decode (no GPU involvement)
──────────────────────────────────────────────────
  Switch time: 0.3s
  Avg: 10.12 tok/s
    Run 1: 10.09 tok/s (64 tok in 6.3s, TTFT=0.88s)
    Run 2: 10.09 tok/s (64 tok in 6.3s, TTFT=0.92s)
    Run 3: 10.19 tok/s (64 tok in 6.3s, TTFT=0.93s)
  VRAM: GPU0=9832MB

>>> BEST DECODE: lru (10.26 tok/s)

======================================================================
SUMMARY
======================================================================

Prefill strategies (ranked by tok/s):
  Strategy                  tok/s   TTFT (s)                 VRAM
  ──────────────────── ────────── ────────── ────────────────────
  hcs_prefill               569.9      17.55                12963 <<<
  chunked                   153.0      65.36                10390
  active_only               115.7      86.39                10396
  persistent               FAILED CUDA OOM
  layer_grouped_2          FAILED CUDA OOM
  layer_grouped_4          FAILED CUDA OOM

Decode strategies (ranked by tok/s):
  Strategy                  tok/s                 VRAM
  ──────────────────── ────────── ────────────────────
  lru                       10.26                12928 <<<
  compact                   10.19                10663
  hcs_hybrid                10.14                12328
  pure_cpu                  10.12                 9832

Optimal pair: prefill=hcs_prefill, decode=lru
======================================================================

================================================================
KRASIS BENCHMARK
================================================================

Collecting system info...
  Model: Qwen3-Coder-Next
  GPUs: 3, CPU: AMD EPYC 7742 64-Core Processor
  Strategy: gpu_decode (lru)

Building test prompts...
  Prefill prompt: 10000 tokens
  Decode prompt: 16 tokens

Warmup phase...
  Warmup: 2 short generations...
  Warmup complete.

Prefill benchmark (10000 tokens, 3 runs)...
  Average: 55.2 tok/s, TTFT=181.18s

Decode benchmark (64 tokens, 3 runs)...
  Average: 10.00 tok/s (100.0ms/tok)
2026-02-15 14:29:07,357 krasis.server INFO Model loaded, starting server on 0.0.0.0:8080
INFO:     Started server process [3107328]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
